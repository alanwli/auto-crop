<html>
<head>
  <style>
    #filedrag
    {
      display: none;
      font-weight: bold;
      text-align: center;
      padding: 2em 0;
      margin: auto;
      color: #555;
      border: 3px dashed #555;
      border-radius: 20px;
      cursor: default;
      height: 20%;
      width: 50%;
    }

    #filedrag.hover
    {
      color: #0080ff;
      border-color: #0080ff;
      border-style: 3px dashed #0080ff;
      box-shadow: inset 0 3px 4px #888;
    }

    .progress_outer {
      display: none;
      margin: auto;
      border: 1px solid #000;
      width: 50%;
    }

    .progress {
      width: 0%;
      background: url("img/progressbar.gif");
      height: 20px;
    }
  </style>
</head>
<body>
  <div>
    <form id="uploadForm" action="api/auto-crop/upload" method="post" enctype="multipart/form-data">
      <div>
        <input type="file" id="fileselect" name="fileselect" accept="image/jpeg,image/png"/>
        <div id="filedrag">drag scanned image (jpeg or png) file here to auto crop</div>
      </div>
    </form>
    <div id='_progress_outer' class='progress_outer'>
      <div id='_progress' class='progress'></div>
    </div>
  </div>

  <script language="javascript">
    if (window.File && window.FileReader && window.FileList && window.Blob) {
      var fileselect = document.getElementById("fileselect");
      var filedrag = document.getElementById("filedrag");
      var progress = document.getElementById("_progress");
      var progress_outer = document.getElementById("_progress_outer");

      // file drop
      filedrag.addEventListener("dragover", FileDragHover, false);
      filedrag.addEventListener("dragleave", FileDragHover, false);
      filedrag.addEventListener("drop", FileSelectHandler, false);
      filedrag.style.display = "block";

      // remove submit button
      fileselect.style.display = "none";
    }

    // file drag hover
    function FileDragHover(e) {
      e.stopPropagation();
      e.preventDefault();
      e.target.className = (e.type == "dragover" ? "hover" : "");
    }

    function FileSelectHandler(e) {
      progress.style.background = 'url("img/progressbar.gif")';
      progress.style.width = '0%';

      // cancel event and hover styling
      FileDragHover(e);
      // fetch FileList object
      var files = e.target.files || e.dataTransfer.files;
      // process all File objects
      for (var i = 0, f; f = files[i]; i++) {
        upload(f);
      }
    }

    function upload(file) {
      progress_outer.style.display = "block";
      progress.style.width = '0%';
      var formData = new FormData();
      formData.append("fileselect", file);

      var xhr = new XMLHttpRequest();

      // this handler will update the progress meter
      xhr.upload.addEventListener('progress', function(e) {
        progress.style.width = (Math.ceil(e.loaded/e.total) * 100 * 0.75) + '%';
      }, false);
      // when upload is done, then change the status to cropping
      xhr.upload.addEventListener('load', function(e) {
        progress.innerHTML = 'cropping...';
      }, false);

      // TODO other stuff
      xhr.addEventListener('load', function(e) {
        progress.style.background = 'none';
        progress.style.width = '100%';
        if (xhr.status == 200) {
          progress.style.backgroundColor = '#66ff66';
          progress.innerHTML = 'done...';
        } else {
          progress.style.backgroundColor = '#ff6666';
          var response = JSON.parse(xhr.responseText);
          progress.innerHTML = response.message;
        }
      }, false);

      xhr.addEventListener('error', function(e) {
        progress.style.background = 'none';
        progress.style.width = '100%';
        progress.style.backgroundColor = '#ff6666';
        var response = JSON.parse(xhr.responseText);
        progress.innerHTML = response.message;
      }, false);

      // TODO add handlers for error handling
      if (file.type == "image/jpeg" || file.type == "image/png") {
        progress.innerHTML = 'uploading...';
        xhr.open("POST", document.getElementById("uploadForm").action, true);
        xhr.send(formData);
      }
    }
  </script>
</body>
</html>
